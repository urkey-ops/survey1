<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Feedback Survey</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìù</text></svg>" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type="radio"]:checked + label {
            transform: scale(1.1);
            box-shadow: 0 4px 14px rgba(0,0,0,0.1);
            border-color: #3b82f6; /* Tailwind's blue-500 */
        }
        .star-rating input[type="radio"] {
            display: none;
        }
        .star-rating label.star {
            cursor: pointer;
            color: #d1d5db; /* Tailwind's gray-400 */
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .star-rating input[type="radio"]:checked ~ label.star,
        .star-rating:hover input[type="radio"]:checked ~ label.star {
            color: #f59e0b; /* Tailwind's amber-500 */
        }
        .star-rating label.star:hover,
        .star-rating label.star:hover ~ label.star,
        .star-rating input[type="radio"]:checked ~ label.star:hover {
            color: #fcd34d; /* Tailwind's amber-300 */
        }
        #syncButton.hidden, #adminClearButton.hidden {
            display: none;
        }
        /* Custom checkmark styles and animation */
        .checkmark-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }
        .checkmark-circle {
            background-color: #22c55e;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: scale(0);
            animation: bounceIn 0.8s forwards;
            animation-delay: 0.2s;
        }
        .checkmark-icon {
            color: white;
            font-size: 64px;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        /* New loading animation for sync button */
        .sync-loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 sm:p-6 lg:p-8">

    <div class="w-full max-w-lg mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl relative">
        <h1 id="mainTitle" class="text-3xl font-bold text-center text-gray-800 mb-2 cursor-pointer">Customer Feedback</h1>
        <p class="text-center text-gray-500 mb-6">We'd love to hear about your experience.</p>
        
        <button id="syncButton" class="hidden absolute top-4 right-4 text-white text-sm font-semibold bg-blue-500 hover:bg-blue-600 rounded-lg shadow-md px-4 py-2 transition-colors duration-200">
            Sync Data
        </button>
        <button id="adminClearButton" class="hidden absolute top-4 left-4 text-white text-xs font-semibold bg-red-500 hover:bg-red-600 rounded-lg shadow-md px-2 py-1 transition-colors duration-200">
            Clear Queue
        </button>

        <div id="statusMessage" class="hidden text-sm"></div>
        <div id="surveyContent">
            <form id="surveyForm" class="space-y-6">
                <div class="survey-page" data-page="0">
                    <div id="rotatingQuestion" class="block text-gray-700 font-semibold mb-2"></div>
                    <textarea
                        id="comments"
                        name="comments"
                        rows="4"
                        class="shadow-sm resize-none appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                        placeholder="Type your comments here..."
                        required
                    ></textarea>
                </div>
                <div class="survey-page hidden" data-page="1">
                    <label class="block text-gray-700 font-semibold mb-2">2. Overall, how satisfied were you with your visit today?</label>
                    <div class="flex justify-around items-center space-x-4">
                        <input type="radio" id="emojiSad" name="satisfaction" value="Sad" class="hidden">
                        <label for="emojiSad" class="flex flex-col items-center p-4 sm:p-6 bg-white border-2 border-transparent rounded-full hover:bg-gray-50 transition-all duration-300 cursor-pointer">
                            <span class="text-4xl sm:text-5xl">üòû</span>
                            <span class="mt-2 text-gray-500 text-xs sm:text-sm">Sad</span>
                        </label>
                        <input type="radio" id="emojiNeutral" name="satisfaction" value="Neutral" class="hidden">
                        <label for="emojiNeutral" class="flex flex-col items-center p-4 sm:p-6 bg-white border-2 border-transparent rounded-full hover:bg-gray-50 transition-all duration-300 cursor-pointer">
                            <span class="text-4xl sm:text-5xl">üòê</span>
                            <span class="mt-2 text-gray-500 text-xs sm:text-sm">Neutral</span>
                        </label>
                        <input type="radio" id="emojiHappy" name="satisfaction" value="Happy" class="hidden">
                        <label for="emojiHappy" class="flex flex-col items-center p-4 sm:p-6 bg-white border-2 border-transparent rounded-full hover:bg-gray-50 transition-all duration-300 cursor-pointer">
                            <span class="text-4xl sm:text-5xl">üòä</span>
                            <span class="mt-2 text-gray-500 text-xs sm:text-sm">Happy</span>
                        </label>
                    </div>
                </div>
                <div class="survey-page hidden" data-page="2">
                    <label class="block text-gray-700 font-semibold mb-2">3. How would you rate the cleanliness of the facility?</label>
                    <div class="flex justify-between items-center bg-gray-50 rounded-lg p-4">
                        <span class="text-xs text-gray-500">1 (Poor)</span>
                        <div class="flex space-x-2">
                            <input type="radio" id="clean1" name="cleanliness" value="1" class="hidden">
                            <label for="clean1" class="w-10 h-10 flex items-center justify-center text-sm font-medium bg-white rounded-full border border-gray-300 hover:bg-gray-100 transition-colors duration-200 cursor-pointer">1</label>
                            <input type="radio" id="clean2" name="cleanliness" value="2" class="hidden">
                            <label for="clean2" class="w-10 h-10 flex items-center justify-center text-sm font-medium bg-white rounded-full border border-gray-300 hover:bg-gray-100 transition-colors duration-200 cursor-pointer">2</label>
                            <input type="radio" id="clean3" name="cleanliness" value="3" class="hidden">
                            <label for="clean3" class="w-10 h-10 flex items-center justify-center text-sm font-medium bg-white rounded-full border border-gray-300 hover:bg-gray-100 transition-colors duration-200 cursor-pointer">3</label>
                            <input type="radio" id="clean4" name="cleanliness" value="4" class="hidden">
                            <label for="clean4" class="w-10 h-10 flex items-center justify-center text-sm font-medium bg-white rounded-full border border-gray-300 hover:bg-gray-100 transition-colors duration-200 cursor-pointer">4</label>
                            <input type="radio" id="clean5" name="cleanliness" value="5" class="hidden">
                            <label for="clean5" class="w-10 h-10 flex items-center justify-center text-sm font-medium bg-white rounded-full border border-gray-300 hover:bg-gray-100 transition-colors duration-200 cursor-pointer">5</label>
                        </div>
                        <span class="text-xs text-gray-500">5 (Excellent)</span>
                    </div>
                </div>
                <div class="survey-page hidden" data-page="3">
                    <label class="block text-gray-700 font-semibold mb-2">4. How friendly was the volunteer staff?</label>
                    <div class="star-rating flex flex-row-reverse justify-end space-x-1 sm:space-x-2">
                        <input type="radio" id="star5" name="staff_friendliness" value="5">
                        <label for="star5" class="star">
                            <svg class="w-8 h-8 sm:w-10 sm:h-10 fill-current" viewBox="0 0 24 24"><path d="M12 17.27l6.18 3.73-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73-1.64 7.03z"/></svg>
                        </label>
                        <input type="radio" id="star4" name="staff_friendliness" value="4">
                        <label for="star4" class="star">
                            <svg class="w-8 h-8 sm:w-10 sm:h-10 fill-current" viewBox="0 0 24 24"><path d="M12 17.27l6.18 3.73-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73-1.64 7.03z"/></svg>
                        </label>
                        <input type="radio" id="star3" name="staff_friendliness" value="3">
                        <label for="star3" class="star">
                            <svg class="w-8 h-8 sm:w-10 sm:h-10 fill-current" viewBox="0 0 24 24"><path d="M12 17.27l6.18 3.73-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73-1.64 7.03z"/></svg>
                        </label>
                        <input type="radio" id="star2" name="staff_friendliness" value="2">
                        <label for="star2" class="star">
                            <svg class="w-8 h-8 sm:w-10 sm:h-10 fill-current" viewBox="0 0 24 24"><path d="M12 17.27l6.18 3.73-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73-1.64 7.03z"/></svg>
                        </label>
                        <input type="radio" id="star1" name="staff_friendliness" value="1">
                        <label for="star1" class="star">
                            <svg class="w-8 h-8 sm:w-10 sm:h-10 fill-current" viewBox="0 0 24 24"><path d="M12 17.27l6.18 3.73-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73-1.64 7.03z"/></svg>
                        </label>
                    </div>
                </div>
                <div id="survey-navigation" class="flex justify-between items-center mt-6">
                    <button
                        id="backButton"
                        type="button"
                        class="px-6 py-3 text-gray-600 font-bold bg-gray-200 rounded-lg shadow-md hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50 transition-colors"
                        style="visibility: hidden;"
                    >
                        Back
                    </button>
                    <button
                        id="nextButton"
                        type="button"
                        class="px-6 py-3 text-white font-bold bg-blue-600 rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition-colors"
                    >
                        Next
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const form = document.getElementById('surveyForm');
        const statusMessage = document.getElementById('statusMessage');
        const syncButton = document.getElementById('syncButton');
        const adminClearButton = document.getElementById('adminClearButton');
        const mainTitle = document.getElementById('mainTitle');
        const surveyPages = document.querySelectorAll('.survey-page');
        const nextButton = document.getElementById('nextButton');
        const backButton = document.getElementById('backButton');
        const rotatingQuestionEl = document.getElementById('rotatingQuestion');
        const commentsTextarea = document.getElementById('comments');
        const surveyContent = document.getElementById('surveyContent');

        const questions = [
            "1. What did you like about your visit today?",
            "1. What could we do better during your next visit?",
            "1. Do you have any general comments or suggestions?",
            "1. What was the most memorable part of your experience?"
        ];

        let currentPage = 0;
        let questionIndex = 0;
        let typingTimeout;
        let displayTimeout;
        let adminClickCount = 0;
        let adminTimer = null;

        const config = {
            rotationSpeed: 50,
            rotationDisplayTime: 4000,
            resetTime: 5000,
            adminClicksRequired: 5,
            adminClickTimeout: 3000 // ms
        };

        // Helper function to generate a UUID
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function showPage(pageIndex) {
            surveyPages.forEach((page, index) => {
                page.classList.toggle('hidden', index !== pageIndex);
            });
            backButton.style.visibility = pageIndex === 0 ? 'hidden' : 'visible';
            
            if (pageIndex === surveyPages.length - 1) {
                nextButton.textContent = 'Submit Survey';
                nextButton.type = 'submit';
            } else {
                nextButton.textContent = 'Next';
                nextButton.type = 'button';
            }
        }

        function validatePage(pageElement) {
            const textarea = pageElement.querySelector('textarea');
            if (textarea) {
                return textarea.value.trim() !== '';
            }
            const radioButtons = pageElement.querySelectorAll('input[type="radio"]');
            if (radioButtons.length > 0) {
                return Array.from(radioButtons).some(radio => radio.checked);
            }
            return true;
        }

        function showTemporaryMessage(message, type = 'info') {
            const className = type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
            statusMessage.textContent = message;
            statusMessage.className = `block p-4 mb-4 rounded-xl text-center font-medium ${className}`;
            statusMessage.style.display = 'block';
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // --- Offline-first and Sync Logic ---

        function getSurveyQueue() {
            try {
                const queue = JSON.parse(localStorage.getItem('surveyQueue'));
                return Array.isArray(queue) ? queue : [];
            } catch (e) {
                console.error("Failed to parse survey queue from localStorage.", e);
                return [];
            }
        }

        function saveSurveyToQueue(data) {
            const queue = getSurveyQueue();
            queue.push(data);
            localStorage.setItem('surveyQueue', JSON.stringify(queue));
            updateSyncButtonVisibility();
        }

        // The re-thought sync function
        async function syncData() {
            const queue = getSurveyQueue();
            if (queue.length === 0 || !navigator.onLine) {
                updateSyncButtonVisibility();
                return;
            }

            syncButton.textContent = 'Syncing...';
            syncButton.classList.add('sync-loading');
            
            const remainingSubmissions = [...queue];
            let successfullySyncedCount = 0;

            for (let i = 0; i < remainingSubmissions.length; i++) {
                const surveyData = remainingSubmissions[i];
                try {
                    const response = await fetch('/api/submit-survey', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(surveyData)
                    });

                    if (response.ok) {
                        successfullySyncedCount++;
                        // A successful sync means we can remove it from the queue
                        const indexToRemove = queue.findIndex(item => item.id === surveyData.id);
                        if (indexToRemove !== -1) {
                            queue.splice(indexToRemove, 1);
                        }
                    } else {
                        console.error('API responded with an error:', response.status);
                    }
                } catch (error) {
                    console.error('Network or API Error:', error);
                    // If a network error occurs, we break the loop and wait for the next sync attempt
                    break;
                }
            }
            
            // Save the updated queue (with successful entries removed)
            localStorage.setItem('surveyQueue', JSON.stringify(queue));
            
            syncButton.classList.remove('sync-loading');
            updateSyncButtonVisibility();

            if (queue.length === 0) {
                showTemporaryMessage('Sync successful! All data uploaded.');
            } else if (successfullySyncedCount > 0) {
                showTemporaryMessage(`Synced ${successfullySyncedCount} of ${remainingSubmissions.length} surveys. Some failed and were kept in the queue.`);
            } else {
                showTemporaryMessage('Sync failed. Please check your internet connection.', 'error');
            }
        }

        function updateSyncButtonVisibility() {
            const queue = getSurveyQueue();
            if (queue.length > 0 && navigator.onLine) {
                syncButton.classList.remove('hidden');
                syncButton.textContent = `Sync Data (${queue.length})`;
            } else {
                syncButton.classList.add('hidden');
            }
        }
        
        function clearQueue() {
            const queue = getSurveyQueue();
            if (queue.length > 0) {
                if (confirm(`Are you sure you want to clear ${queue.length} unsynced submissions? This action cannot be undone.`)) {
                    localStorage.removeItem('surveyQueue');
                    updateSyncButtonVisibility();
                    showTemporaryMessage('Unsynced data cleared.');
                }
            } else {
                showTemporaryMessage('No unsynced data to clear.');
            }
        }

        function scheduleDailySync() {
            const now = new Date();
            const syncTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 19, 0, 0); // 7:00 PM
            if (now > syncTime) {
                syncTime.setDate(syncTime.getDate() + 1);
            }
            const delay = syncTime.getTime() - now.getTime();
            setTimeout(syncData, delay);
            console.log(`Scheduled next sync for ${syncTime.toLocaleString()}.`);
        }

        // --- Question Rotation Logic ---

        function typeWriter(text, i) {
            if (i < text.length) {
                rotatingQuestionEl.textContent += text.charAt(i);
                typingTimeout = setTimeout(() => typeWriter(text, i + 1), config.rotationSpeed);
            } else {
                displayTimeout = setTimeout(rotateQuestions, config.rotationDisplayTime);
            }
        }

        function rotateQuestions() {
            clearTimeout(typingTimeout);
            clearTimeout(displayTimeout);
            const currentQuestion = questions[questionIndex];
            rotatingQuestionEl.textContent = "";
            questionIndex = (questionIndex + 1) % questions.length;
            typeWriter(currentQuestion, 0);
        }

        commentsTextarea.addEventListener('focus', () => {
            clearTimeout(typingTimeout);
            clearTimeout(displayTimeout);
        });

        commentsTextarea.addEventListener('blur', () => {
            if (commentsTextarea.value.trim() === '') {
                displayTimeout = setTimeout(rotateQuestions, config.rotationDisplayTime);
            }
        });

        // --- Event Listeners ---
        
        nextButton.addEventListener('click', () => {
            const currentPageElement = surveyPages[currentPage];
            const isPageValid = validatePage(currentPageElement);

            if (isPageValid) {
                currentPageElement.querySelectorAll('textarea, input[type="radio"], label').forEach(el => {
                    el.classList.remove('border-red-500');
                    if (el.nextElementSibling) el.nextElementSibling.classList.remove('border-red-500');
                });
                statusMessage.style.display = 'none';
                
                if (currentPage < surveyPages.length - 1) {
                    currentPage++;
                    showPage(currentPage);
                } else {
                    form.dispatchEvent(new Event('submit', { cancelable: true }));
                }
            } else {
                statusMessage.textContent = 'Please answer the current question to continue.';
                statusMessage.className = 'block p-4 mb-4 rounded-xl text-center bg-red-100 text-red-700 font-medium';
                statusMessage.style.display = 'block';

                currentPageElement.querySelectorAll('textarea, input[type="radio"], label').forEach(el => {
                    if (el.tagName === 'LABEL' && el.previousElementSibling.type === 'radio') {
                        el.classList.add('border-red-500');
                    } else if (el.tagName === 'TEXTAREA') {
                        el.classList.add('border-red-500');
                    }
                });
            }
        });
        
        backButton.addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                showPage(currentPage);
                statusMessage.style.display = 'none';
            }
        });

        syncButton.addEventListener('click', syncData);

        // Secure Admin Access Logic
        mainTitle.addEventListener('click', () => {
            adminClickCount++;
            if (adminClickCount === 1) {
                adminTimer = setTimeout(() => {
                    adminClickCount = 0;
                }, config.adminClickTimeout);
            } else if (adminClickCount >= config.adminClicksRequired) {
                clearTimeout(adminTimer);
                adminClickCount = 0;
                adminClearButton.classList.toggle('hidden');
                showTemporaryMessage('Admin button toggled.');
            }
        });

        adminClearButton.addEventListener('click', clearQueue);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const data = {
                // Generate a UUID to uniquely identify this submission
                id: uuidv4(),
                question: rotatingQuestionEl.textContent,
                comments: formData.get('comments'),
                satisfaction: formData.get('satisfaction'),
                cleanliness: formData.get('cleanliness'),
                staff_friendliness: formData.get('staff_friendliness')
            };

            saveSurveyToQueue(data);
            
            surveyContent.style.display = 'none';
            statusMessage.style.display = 'block';
            statusMessage.innerHTML = `
                <div class="checkmark-container">
                    <div class="checkmark-circle">
                        <span class="checkmark-icon">&#10003;</span>
                    </div>
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mt-6">Thank you!</h2>
                    <p class="text-gray-500 mt-2">Your feedback has been submitted.</p>
                </div>
            `;
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
                surveyContent.style.display = 'block';
                form.reset();
                currentPage = 0;
                showPage(currentPage);
                rotateQuestions();
            }, config.resetTime);
        });

        // Network status listeners
        window.addEventListener('online', () => {
            syncData();
            updateSyncButtonVisibility();
        });

        window.addEventListener('offline', () => {
            updateSyncButtonVisibility();
        });

        // Initial setup
        showPage(currentPage);
        rotateQuestions();
        updateSyncButtonVisibility();
        scheduleDailySync();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Feedback Survey</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìù</text></svg>" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type="radio"]:checked + label {
            transform: scale(1.1);
            box-shadow: 0 4px 14px rgba(0,0,0,0.1);
            border-color: #3b82f6; /* Tailwind's blue-500 */
        }
        /* Custom styling for the star rating to fill on hover and selection */
        .star-rating input[type="radio"] {
            display: none;
        }
        .star-rating label.star {
            cursor: pointer;
            color: #d1d5db; /* Tailwind's gray-400 */
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .star-rating input[type="radio"]:checked ~ label.star,
        .star-rating:hover input[type="radio"]:checked ~ label.star {
            color: #f59e0b; /* Tailwind's amber-500 */
        }
        .star-rating label.star:hover,
        .star-rating label.star:hover ~ label.star,
        .star-rating input[type="radio"]:checked ~ label.star:hover {
            color: #fcd34d; /* Tailwind's amber-300 */
        }
        /* Style for validation error highlight */
        .error-highlight {
            border-color: #ef4444; /* Tailwind's red-500 */
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5; /* Tailwind's violet-600 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 sm:p-6 lg:p-8">

    <div class="relative w-full max-w-2xl mx-auto bg-white p-8 sm:p-10 rounded-2xl shadow-xl">
        <!-- Manual Sync Button and Loading Indicator -->
        <div class="absolute top-4 right-4 z-10">
            <!-- Sync Button - requires a long press to activate sync -->
            <button id="syncButton" class="group p-2 rounded-full text-purple-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 group-hover:rotate-180 transition-transform duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.012 3.96l.707-.707m2.228 2.228.707-.707m-5.496-5.496l-.707-.707m-1.728-1.728l-.707-.707M10 13a4 4 0 11-4-4m4 4v5m-4-5l.707-.707m2.228 2.228.707-.707m-5.496-5.496l-.707-.707m-1.728-1.728l-.707-.707" />
                </svg>
                <span id="syncCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-semibold w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
            </button>
            <!-- Loading Indicator -->
            <div id="syncLoading" class="hidden flex items-center justify-center p-2">
                <div class="spinner"></div>
            </div>
        </div>

        <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">Customer Feedback</h1>
        <!-- Progress Indicator -->
        <p id="progressIndicator" class="text-center text-gray-500 text-lg mb-8">Page 1 of 4</p>

        <!-- Status message container -->
        <div id="statusMessage" class="hidden text-sm"></div>

        <form id="surveyForm" class="space-y-8">

            <!-- Question 1: Text -->
            <div class="survey-page" data-page="0">
                <label for="comments" class="block text-gray-700 text-xl font-semibold mb-2">1. Write us about your experience today. Any comment or suggestion?</label>
                <textarea
                    id="comments"
                    name="comments"
                    rows="5"
                    class="shadow-sm resize-none appearance-none border border-gray-300 rounded-xl w-full py-4 px-5 text-lg text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                    placeholder="Type your comments here..."
                ></textarea>
                <span id="comments-error-msg" class="text-sm text-red-500 hidden">This field is required.</span>
            </div>

            <!-- Question 2: Emoticon Rating -->
            <div class="survey-page hidden" data-page="1">
                <label class="block text-gray-700 text-xl font-semibold mb-2">2. Overall, how satisfied were you with your visit today?</label>
                <div class="flex justify-around items-center space-x-6">
                    <input type="radio" id="emojiSad" name="satisfaction" value="Sad" class="hidden">
                    <label for="emojiSad" class="flex flex-col items-center p-6 sm:p-8 bg-white border-2 border-transparent rounded-full hover:bg-gray-50 transition-all duration-300 cursor-pointer">
                        <span class="text-5xl sm:text-6xl">üòû</span>
                        <span class="mt-2 text-gray-500 text-base sm:text-lg">Sad</span>
                    </label>

                    <input type="radio" id="emojiNeutral" name="satisfaction" value="Neutral" class="hidden">
                    <label for="emojiNeutral" class="flex flex-col items-center p-6 sm:p-8 bg-white border-2 border-transparent rounded-full hover:bg-gray-50 transition-all duration-300 cursor-pointer">
                        <span class="text-5xl sm:text-6xl">üòê</span>
                        <span class="mt-2 text-gray-500 text-base sm:text-lg">Neutral</span>
                    </label>

                    <input type="radio" id="emojiHappy" name="satisfaction" value="Happy" class="hidden">
                    <label for="emojiHappy" class="flex flex-col items-center p-6 sm:p-8 bg-white border-2 border-transparent rounded-full hover:bg-gray-50 transition-all duration-300 cursor-pointer">
                        <span class="text-5xl sm:text-6xl">üòä</span>
                        <span class="mt-2 text-gray-500 text-base sm:text-lg">Happy</span>
                    </label>
                </div>
                <span id="satisfaction-error-msg" class="text-sm text-red-500 text-center block mt-2 hidden">Please select an option.</span>
            </div>

            <!-- Question 3: Linear Scale -->
            <div class="survey-page hidden" data-page="2">
                <label class="block text-gray-700 text-xl font-semibold mb-2">3. How would you rate the cleanliness of the facility?</label>
                <div class="flex justify-between items-center bg-gray-50 rounded-lg p-6">
                    <span class="text-sm text-gray-500">1 (Poor)</span>
                    <div class="flex space-x-4">
                        <input type="radio" id="clean1" name="cleanliness" value="1" class="hidden">
                        <label for="clean1" class="w-12 h-12 flex items-center justify-center text-lg font-medium bg-white rounded-full border border-gray-300 hover:bg-gray-100 transition-colors duration-200 cursor-pointer">1</label>
                        
                        <input type="radio" id="clean2" name="cleanliness" value="2" class="hidden">
                        <label for="clean2" class="w-12 h-12 flex items-center justify-center text-lg font-medium bg-white rounded-full border border-gray-300 hover:bg-gray-100 transition-colors duration-200 cursor-pointer">2</label>
                        
                        <input type="radio" id="clean3" name="cleanliness" value="3" class="hidden">
                        <label for="clean3" class="w-12 h-12 flex items-center justify-center text-lg font-medium bg-white rounded-full border border-gray-300 hover:bg-gray-100 transition-colors duration-200 cursor-pointer">3</label>
                        
                        <input type="radio" id="clean4" name="cleanliness" value="4" class="hidden">
                        <label for="clean4" class="w-12 h-12 flex items-center justify-center text-lg font-medium bg-white rounded-full border border-gray-300 hover:bg-gray-100 transition-colors duration-200 cursor-pointer">4</label>
                        
                        <input type="radio" id="clean5" name="cleanliness" value="5" class="hidden">
                        <label for="clean5" class="w-12 h-12 flex items-center justify-center text-lg font-medium bg-white rounded-full border border-gray-300 hover:bg-gray-100 transition-colors duration-200 cursor-pointer">5</label>
                    </div>
                    <span class="text-sm text-gray-500">5 (Excellent)</span>
                </div>
                <span id="cleanliness-error-msg" class="text-sm text-red-500 text-center block mt-2 hidden">Please select an option.</span>
            </div>

            <!-- Question 4: Star Rating -->
            <div class="survey-page hidden" data-page="3">
                <label class="block text-gray-700 text-xl font-semibold mb-2">4. How friendly was the volunteer staff?</label>
                <div class="star-rating flex flex-row-reverse justify-end space-x-2 sm:space-x-4">
                    <input type="radio" id="star5" name="staff_friendliness" value="5">
                    <label for="star5" class="star">
                        <svg class="w-10 h-10 sm:w-12 sm:h-12 fill-current" viewBox="0 0 24 24"><path d="M12 17.27l6.18 3.73-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73-1.64 7.03z"/></svg>
                    </label>
                    <input type="radio" id="star4" name="staff_friendliness" value="4">
                    <label for="star4" class="star">
                        <svg class="w-10 h-10 sm:w-12 sm:h-12 fill-current" viewBox="0 0 24 24"><path d="M12 17.27l6.18 3.73-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73-1.64 7.03z"/></svg>
                    </label>
                    <input type="radio" id="star3" name="staff_friendliness" value="3">
                    <label for="star3" class="star">
                        <svg class="w-10 h-10 sm:w-12 sm:h-12 fill-current" viewBox="0 0 24 24"><path d="M12 17.27l6.18 3.73-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73-1.64 7.03z"/></svg>
                    </label>
                    <input type="radio" id="star2" name="staff_friendliness" value="2">
                    <label for="star2" class="star">
                        <svg class="w-10 h-10 sm:w-12 sm:h-12 fill-current" viewBox="0 0 24 24"><path d="M12 17.27l6.18 3.73-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73-1.64 7.03z"/></svg>
                    </label>
                    <input type="radio" id="star1" name="staff_friendliness" value="1">
                    <label for="star1" class="star">
                        <svg class="w-10 h-10 sm:w-12 sm:h-12 fill-current" viewBox="0 0 24 24"><path d="M12 17.27l6.18 3.73-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73-1.64 7.03z"/></svg>
                    </label>
                </div>
                <span id="staff_friendliness-error-msg" class="text-sm text-red-500 text-center block mt-2 hidden">Please select an option.</span>
            </div>

            <!-- Navigation Buttons -->
            <div id="survey-navigation" class="flex justify-between items-center mt-8">
                <button
                    id="backButton"
                    type="button"
                    class="px-8 py-4 text-gray-600 font-bold bg-gray-200 rounded-lg shadow-md hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50 transition-colors"
                    style="visibility: hidden;"
                >
                    Back
                </button>
                <button
                    id="nextButton"
                    type="button"
                    class="px-8 py-4 text-white font-bold bg-blue-600 rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                    Next
                </button>
            </div>
        </form>
    </div>

    <script>
        (function() {
            const form = document.getElementById('surveyForm');
            const statusMessage = document.getElementById('statusMessage');
            const surveyPages = document.querySelectorAll('.survey-page');
            const nextButton = document.getElementById('nextButton');
            const backButton = document.getElementById('backButton');
            const syncButton = document.getElementById('syncButton');
            const syncCount = document.getElementById('syncCount');
            const syncLoading = document.getElementById('syncLoading');
            const progressIndicator = document.getElementById('progressIndicator');
            const LOCAL_STORAGE_KEY = 'pending-surveys';
            const LAST_SYNC_KEY = 'last-sync-date';

            let currentPage = 0;
            let isSyncing = false; // Flag to prevent concurrent syncs
            let longPressTimer;
            const LONG_PRESS_DURATION = 1500; // 1.5 seconds

            // Map page data attributes to their corresponding error message IDs
            const validationMessages = {
                '0': { type: 'textarea', id: 'comments', msgId: 'comments-error-msg' },
                '1': { type: 'radio', name: 'satisfaction', msgId: 'satisfaction-error-msg' },
                '2': { type: 'radio', name: 'cleanliness', msgId: 'cleanliness-error-msg' },
                '3': { type: 'radio', name: 'staff_friendliness', msgId: 'staff_friendliness-error-msg' }
            };

            function showPage(pageIndex) {
                surveyPages.forEach((page, index) => {
                    page.classList.toggle('hidden', index !== pageIndex);
                });

                progressIndicator.textContent = `Question ${pageIndex + 1} of ${surveyPages.length}`;

                backButton.style.visibility = pageIndex === 0 ? 'hidden' : 'visible';
                if (pageIndex === surveyPages.length - 1) {
                    nextButton.textContent = 'Submit Survey';
                } else {
                    nextButton.textContent = 'Next';
                }
            }

            function clearValidationErrors() {
                document.querySelectorAll('.error-highlight').forEach(el => el.classList.remove('error-highlight'));
                document.querySelectorAll('.text-red-500').forEach(el => el.classList.add('hidden'));
            }

            function validatePage(pageElement) {
                const pageNum = pageElement.dataset.page;
                const validationInfo = validationMessages[pageNum];

                if (!validationInfo) return true; // No validation needed for this page

                if (validationInfo.type === 'textarea') {
                    const textarea = pageElement.querySelector('textarea');
                    if (!textarea.value.trim()) {
                        textarea.classList.add('error-highlight');
                        document.getElementById(validationInfo.msgId).classList.remove('hidden');
                        return false;
                    }
                } else if (validationInfo.type === 'radio') {
                    const isChecked = Array.from(pageElement.querySelectorAll(`input[name="${validationInfo.name}"]`)).some(radio => radio.checked);
                    if (!isChecked) {
                        pageElement.classList.add('error-highlight');
                        document.getElementById(validationInfo.msgId).classList.remove('hidden');
                        return false;
                    }
                }

                return true;
            }

            // Enhanced function to send a single survey with better error handling
            async function submitSurvey(data) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10-second timeout

                try {
                    const response = await fetch('/api/submit-survey', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                        signal: controller.signal
                    });
                    
                    if (!response.ok) {
                        // Throw an error for non-200 responses to be caught by the main sync function
                        const errorMsg = `HTTP Error: ${response.status} ${response.statusText}`;
                        throw new Error(errorMsg);
                    }

                    clearTimeout(timeoutId);
                    return { status: 'fulfilled', value: response };
                } catch (error) {
                    clearTimeout(timeoutId);
                    let errorReason = error.message;
                    if (error.name === 'AbortError') {
                        errorReason = 'Request timed out.';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorReason = 'Network error or server unreachable.';
                    }
                    console.error('Submission failed:', errorReason, error);
                    return { status: 'rejected', reason: errorReason };
                }
            }

            function saveSurveyLocally(data) {
                let pendingSurveys = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
                pendingSurveys.push(data);
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pendingSurveys));
                updateSyncButton();
            }

            function updateSyncButton() {
                const pendingSurveys = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
                if (pendingSurveys.length > 0) {
                    syncCount.textContent = pendingSurveys.length;
                    syncCount.classList.remove('hidden');
                } else {
                    syncCount.classList.add('hidden');
                }
            }

            function setButtonsDisabled(disabled) {
                nextButton.disabled = disabled;
                backButton.disabled = disabled;
                nextButton.classList.toggle('disabled:bg-gray-400', disabled);
            }

            async function syncSurveys() {
                if (isSyncing) {
                    console.log("Sync already in progress. Skipping.");
                    return;
                }
                isSyncing = true;
                setButtonsDisabled(true);
                syncButton.classList.add('hidden');
                syncLoading.classList.remove('hidden');
                
                const pendingSurveys = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
                if (pendingSurveys.length === 0) {
                    showStatus('gray', 'No surveys to sync.');
                    isSyncing = false;
                    setButtonsDisabled(false);
                    syncLoading.classList.add('hidden');
                    syncButton.classList.remove('hidden');
                    return;
                }

                showStatus('blue', `Syncing ${pendingSurveys.length} survey(s)...`);

                // Use Promise.allSettled to send all surveys in parallel
                const promises = pendingSurveys.map(submitSurvey);
                const results = await Promise.allSettled(promises);
                
                let successCount = 0;
                const failedSurveys = [];

                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value.value.ok) {
                        successCount++;
                    } else {
                        failedSurveys.push(pendingSurveys[index]);
                    }
                });
                
                // Save only the failed surveys back to local storage
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(failedSurveys));
                updateSyncButton();

                // Update the last sync date only if at least one survey was synced successfully
                if (successCount > 0) {
                    const today = new Date().toLocaleDateString();
                    localStorage.setItem(LAST_SYNC_KEY, today);
                }

                // Provide detailed feedback
                if (failedSurveys.length === 0) {
                    showStatus('green', `All ${successCount} surveys synced successfully!`);
                } else {
                    showStatus('red', `${successCount} surveys synced, ${failedSurveys.length} failed. They will be retried later.`);
                }

                isSyncing = false;
                setButtonsDisabled(false);
                syncLoading.classList.add('hidden');
                syncButton.classList.remove('hidden');
            }

            function showStatus(color, message) {
                const classes = {
                    'gray': 'bg-gray-100 text-gray-700 font-medium',
                    'blue': 'bg-blue-100 text-blue-700 font-medium',
                    'green': 'bg-green-100 text-green-700 font-medium',
                    'red': 'bg-red-100 text-red-700 font-medium'
                };
                statusMessage.className = `block p-4 mb-4 rounded-xl text-center ${classes[color]}`;
                statusMessage.textContent = message;
                statusMessage.style.display = 'block';
            }
            
            function checkAndAutoSync() {
                const lastSyncDate = localStorage.getItem(LAST_SYNC_KEY);
                const today = new Date().toLocaleDateString();
                const pendingSurveys = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
                const now = new Date();
                const currentHour = now.getHours();
                const syncHour = 20; // 8 PM

                if (lastSyncDate !== today && currentHour >= syncHour && pendingSurveys.length > 0) {
                    console.log("It's a new day and it's past the sync time. Auto-syncing...");
                    syncSurveys();
                } else {
                    console.log("Auto-sync conditions not met. Skipping.");
                }
            }

            // Event listener for long press to trigger sync
            syncButton.addEventListener('mousedown', startLongPress);
            syncButton.addEventListener('touchstart', startLongPress);
            syncButton.addEventListener('mouseup', endLongPress);
            syncButton.addEventListener('touchend', endLongPress);
            syncButton.addEventListener('mouseout', endLongPress);

            function startLongPress() {
                longPressTimer = setTimeout(() => {
                    syncSurveys();
                }, LONG_PRESS_DURATION);
            }

            function endLongPress() {
                clearTimeout(longPressTimer);
            }

            // Add event listeners for navigation
            nextButton.addEventListener('click', () => {
                clearValidationErrors();
                const currentPageElement = surveyPages[currentPage];
                if (!validatePage(currentPageElement)) {
                    showStatus('red', 'Please answer the current question to continue.');
                    return;
                }
                statusMessage.style.display = 'none';

                if (currentPage < surveyPages.length - 1) {
                    currentPage++;
                    showPage(currentPage);
                } else {
                    submitForm();
                }
            });

            backButton.addEventListener('click', () => {
                if (currentPage > 0) {
                    currentPage--;
                    showPage(currentPage);
                }
            });

            async function submitForm() {
                setButtonsDisabled(true);
                clearValidationErrors();
                
                const formData = new FormData(form);
                const data = {
                    comments: formData.get('comments'),
                    satisfaction: formData.get('satisfaction'),
                    cleanliness: formData.get('cleanliness'),
                    staff_friendliness: formData.get('staff_friendliness')
                };

                saveSurveyLocally(data);

                showStatus('blue', 'Survey saved locally. It will be synced later.');

                form.reset();
                currentPage = 0;
                showPage(currentPage);
                setButtonsDisabled(false);
            }

            form.addEventListener('submit', (e) => {
                 e.preventDefault();
            });

            // Initialize the survey on page load
            showPage(currentPage);
            updateSyncButton();
            checkAndAutoSync();
            
            // Periodically check for auto-sync every hour
            setInterval(checkAndAutoSync, 60 * 60 * 1000); 
        })();
    </script>
</body>
</html>
